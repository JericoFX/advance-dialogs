<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advance Dialog V2 - Mock Test</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .mock-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 20px;
            z-index: 10000;
            max-width: 380px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .mock-controls h2 {
            color: #00ff88;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .mock-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mock-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .mock-section h3 {
            color: #00ff88;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mock-button {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .mock-button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            transform: translateX(5px);
        }

        .mock-button.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }

        .mock-button.new-feature {
            border-left: 3px solid #00ff88;
        }

        .mock-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            font-size: 13px;
        }

        .mock-input:focus {
            outline: none;
            border-color: #00ff88;
        }

        .mock-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .mock-log {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            max-height: 180px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .log-entry {
            color: #a0a0a0;
            margin-bottom: 6px;
            padding-left: 10px;
            border-left: 2px solid #00ff88;
        }

        .log-entry.success {
            border-left-color: #00ff88;
            color: #00ff88;
        }

        .log-entry.error {
            border-left-color: #ff4444;
            color: #ff4444;
        }

        .log-entry.info {
            border-left-color: #4488ff;
            color: #4488ff;
        }

        .log-entry.warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }

        .mock-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 11px;
            color: #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .mock-preview pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .instructions {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 20px;
            z-index: 10000;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .instructions h3 {
            color: #00ff88;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            color: #e0e0e0;
            font-size: 12px;
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .instructions li::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #00ff88;
            font-weight: bold;
        }

        .feature-badge {
            display: inline-block;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 8px;
        }

        .npc-preview {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 16px;
            padding: 25px 35px;
            z-index: 1;
            text-align: center;
        }

        .npc-preview img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(0, 255, 136, 0.4);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .npc-name {
            color: #ffffff;
            font-size: 16px;
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
        }

        .npc-role {
            color: #00ff88;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- NPC Preview Placeholder -->
    <div class="npc-preview">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' fill='%23333' rx='60'/%3E%3Ctext x='60' y='70' text-anchor='middle' fill='%23fff' font-size='50'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="NPC">
        <div class="npc-name">Advance Dialog V2</div>
        <div class="npc-role">Modern Dialog System</div>
    </div>

    <!-- Mock Controls -->
    <div class="mock-controls">
        <h2>ðŸŽ® Advance Dialog V2 Mock</h2>

        <div class="mock-section">
            <h3>Basic Dialogs</h3>
            <button class="mock-button" onclick="showSimpleDialog()">Simple Dialog</button>
            <button class="mock-button" onclick="showChainDialog()">Dialog Chain</button>
            <button class="mock-button" onclick="showLongDialog()">Long Text</button>
        </div>

        <div class="mock-section">
            <h3>New V2 Features <span class="feature-badge">NEW</span></h3>
            <button class="mock-button new-feature" onclick="showBackButtonDialog()">Back Button Navigation</button>
            <button class="mock-button new-feature" onclick="showFacialAnimationDialog()">Facial Animations</button>
            <button class="mock-button new-feature" onclick="showCameraDialog()">Camera System</button>
            <button class="mock-button new-feature" onclick="showDataPersistenceDialog()">Data Persistence</button>
            <button class="mock-button new-feature" onclick="showVehicleHelperDialog()">Vehicle Helpers</button>
        </div>

        <div class="mock-section">
            <h3>Custom Dialog</h3>
            <input type="text" class="mock-input" id="speakerInput" placeholder="NPC Name (e.g., Mechanic)">
            <textarea class="mock-input" id="textInput" placeholder="Dialog text..." rows="2"></textarea>
            <input type="text" class="mock-input" id="option1Input" placeholder="Option 1 (e.g., Yes)">
            <input type="text" class="mock-input" id="option2Input" placeholder="Option 2 (e.g., No)">
            <button class="mock-button" onclick="showCustomDialog()">Show Custom Dialog</button>
        </div>

        <div class="mock-section">
            <h3>Actions</h3>
            <button class="mock-button" onclick="closeDialog()">Close Dialog (ESC)</button>
            <button class="mock-button" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="mock-section">
            <h3>Event Log</h3>
            <div class="mock-log" id="mockLog"></div>
        </div>

        <div class="mock-section">
            <h3>JSON Preview</h3>
            <div class="mock-preview" id="jsonPreview">
                <pre>Waiting for data...</pre>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions">
        <h3>ðŸ“– V2 Features</h3>
        <ul>
            <li><strong>registerDialog()</strong> - Register once, use anywhere</li>
            <li><strong>onSelect(ctx, task)</strong> - Clean linear code</li>
            <li><strong>task.goTo()</strong> - Smart movement with timeout</li>
            <li><strong>task.data.*</strong> - SQL persistence</li>
            <li><strong>Facial animations</strong> - Happy, angry, surprised...</li>
            <li><strong>Camera system</strong> - Follow, track, orbit modes</li>
            <li><strong>Auto back button</strong> - Navigation history</li>
            <li><strong>Vehicle helpers</strong> - Get closest, by model...</li>
            <li><strong>Error protection</strong> - Never blocks NUI</li>
        </ul>
    </div>

    <!-- Dialog Container -->
    <div id="dialog-container" class="dialog-container hidden">
        <div class="dialog-box">
            <div class="dialog-header">
                <div id="speaker" class="speaker"></div>
            </div>
            <div class="dialog-body">
                <div id="dialog-text" class="text"></div>
            </div>
            <div class="dialog-footer">
                <div id="options" class="options"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock GetParentResourceName function
        window.GetParentResourceName = function() {
            return 'advance-dialog-mock';
        };

        // Mock dialog state
        let mockCurrentDialog = null;
        let mockActiveDialogId = null;
        let mockDialogHistory = [];
        let mockDataStore = {}; // Simulates SQL persistence

        // Dialog presets showcasing V2 features
        const dialogs = {
            simple: {
                id: "simple_dialog",
                speaker: "Welcome NPC",
                text: "Welcome to Advance Dialog V2! This system features clean API, automatic navigation, and SQL persistence.",
                options: [
                    {
                        label: "Show me features",
                        description: "Learn about V2 capabilities",
                        next: "features_dialog"
                    },
                    {
                        label: "Close",
                        close: true
                    }
                ]
            },
            features: {
                id: "features_dialog",
                speaker: "System Info",
                text: "V2 Features: registerDialog() + openDialog(), onSelect(ctx, task), task.goTo(), task.data.* for persistence, facial animations, camera system, and more!",
                options: [
                    { label: "Try navigation", next: "nav_start" },
                    { label: "Close", close: true }
                ]
            },
            nav_start: {
                id: "nav_start",
                speaker: "Navigation Demo",
                text: "This demonstrates the automatic Back button. Go deeper into the menu chain.",
                options: [
                    { label: "Go deeper â†’", next: "nav_mid" },
                    { label: "Close", close: true }
                ]
            },
            nav_mid: {
                id: "nav_mid",
                speaker: "Level 2",
                text: "You're now 2 levels deep. Notice the automatic Back button in every menu!",
                options: [
                    { label: "Go deeper â†’", next: "nav_deep" },
                    { label: "Close", close: true }
                ]
            },
            nav_deep: {
                id: "nav_deep",
                speaker: "Level 3",
                text: "Deepest level! The Back button appears automatically when there's history. Each click returns you to the previous menu.",
                options: [
                    { label: "Close", close: true }
                ]
            },
            facial: {
                id: "facial_demo",
                speaker: "Expression Master",
                text: "Facial animation presets: happy, angry, sad, surprised, aiming, injured, concentrated, shocked, and more!",
                options: [
                    {
                        label: "ðŸ˜Š Happy",
                        description: "Play happy facial animation",
                        onSelect: "facial_happy"
                    },
                    {
                        label: "ðŸ˜  Angry",
                        description: "Play angry facial animation",
                        onSelect: "facial_angry"
                    },
                    {
                        label: "ðŸ˜² Surprised",
                        description: "Play surprised facial animation",
                        onSelect: "facial_surprised"
                    },
                    { label: "Close", close: true }
                ]
            },
            camera: {
                id: "camera_demo",
                speaker: "Camera Operator",
                text: "Camera modes: static (fixed position), follow (moves with target), track (fixed position, points at moving target), orbit (rotates around target).",
                options: [
                    { label: "Follow mode", onSelect: "camera_follow" },
                    { label: "Track mode", onSelect: "camera_track" },
                    { label: "Orbit mode", onSelect: "camera_orbit" },
                    { label: "Close", close: true }
                ]
            },
            persistence: {
                id: "persistence_demo",
                speaker: "Data Manager",
                text: "SQL persistence with automatic cleanup: 100 entries limit per player, 30-day auto-expiration. Uses MariaDB triggers for zero Lua overhead!",
                options: [
                    { label: "Save test data", onSelect: "data_save" },
                    { label: "Load test data", onSelect: "data_load" },
                    { label: "Check completion", onSelect: "data_check" },
                    { label: "Close", close: true }
                ]
            },
            vehicle: {
                id: "vehicle_demo",
                speaker: "Vehicle Helper",
                text: "Utility functions: task.vehicle.getClosest(), getByModel(), getByPlate(), getInFront(). Also task.goToVehicle() with bone support!",
                options: [
                    { label: "Find closest vehicle", onSelect: "veh_closest" },
                    { label: "Go to vehicle hood", onSelect: "veh_hood" },
                    { label: "Close", close: true }
                ]
            },
            long: {
                id: "long_dialog",
                speaker: "Storyteller",
                text: "In the realm of dreams, where stars dance to the rhythm of eternal wind, there exists an ancient legend that tells the story of a traveler lost in time. This traveler, seeking answers to questions not yet formulated, crossed borders that no mortal had dared to cross before.",
                options: [
                    { label: "Continue story", next: "long_2" },
                    { label: "Close", close: true }
                ]
            },
            long_2: {
                id: "long_2",
                speaker: "Storyteller",
                text: "With the passage of centuries, the traveler learned that the deepest answers are not found in books or maps, but in the hearts of those who dare to dream. And so, their story became legend, inspiring future generations.",
                options: [
                    { label: "The End", close: true }
                ]
            }
        };

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('mockLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('mockLog').innerHTML = '';
            log('Log cleared', 'info');
        }

        function updateJsonPreview(data) {
            const preview = document.getElementById('jsonPreview');
            preview.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // Show dialog with V2 features
        function showDialog(dialogData) {
            mockCurrentDialog = dialogData;

            if (dialogData.id) {
                mockActiveDialogId = dialogData.id;
            }

            $('#speaker').text(dialogData.speaker || '');
            $('#dialog-text').text(dialogData.text || '');

            $('#options').empty();

            // Add Back button if there's history
            if (mockDialogHistory.length > 0) {
                const backElement = $('<div></div>')
                    .addClass('option back-button')
                    .attr('data-action', 'back');
                
                backElement.append($('<span></span>').addClass('label').text('â† Back'));
                backElement.on('click', function() {
                    goBack();
                });
                
                $('#options').append(backElement);
            }

            if (dialogData.options && Array.isArray(dialogData.options)) {
                dialogData.options.forEach((option, index) => {
                    const optionElement = $('<div></div>')
                        .addClass('option')
                        .attr('data-index', index);

                    const label = $('<span></span>')
                        .addClass('label')
                        .text(option.label || '');

                    optionElement.append(label);

                    if (option.description) {
                        const description = $('<span></span>')
                            .addClass('description')
                            .text(option.description);
                        optionElement.append(description);
                    }

                    optionElement.on('click', function() {
                        handleOption(index);
                    });

                    $('#options').append(optionElement);
                });
            }

            $('#dialog-container').removeClass('hidden');
            updateJsonPreview(dialogData);
            log(`Showing dialog: ${dialogData.id}`, 'success');
        }

        function hideDialog() {
            $('#dialog-container').addClass('hidden');
            mockCurrentDialog = null;
            mockActiveDialogId = null;
            mockDialogHistory = []; // Clear history on close
            $('#options').empty();
            $('#speaker').text('');
            $('#dialog-text').text('');
            log('Dialog closed', 'info');
        }

        function goBack() {
            if (mockDialogHistory.length > 0) {
                const previous = mockDialogHistory.pop();
                showDialog(previous);
                log('Navigated back', 'info');
            }
        }

        function handleOption(index) {
            if (!mockCurrentDialog || !mockCurrentDialog.options) return;

            const option = mockCurrentDialog.options[index];
            if (!option) return;

            log(`Selected: ${option.label}`, 'success');

            // Handle action types
            if (option.action === 'back') {
                goBack();
                return;
            }

            if (option.close) {
                hideDialog();
                return;
            }

            // Handle onSelect simulation
            if (option.onSelect) {
                handleOnSelect(option.onSelect);
                return;
            }

            // Handle next dialog
            if (option.next && dialogs[option.next]) {
                mockDialogHistory.push(mockCurrentDialog);
                showDialog(dialogs[option.next]);
                return;
            }
        }

        function handleOnSelect(action) {
            switch(action) {
                case 'facial_happy':
                    log('Playing facial animation: happy (task.playFacial)', 'success');
                    setTimeout(() => showDialog(dialogs.facial), 500);
                    break;
                case 'facial_angry':
                    log('Playing facial animation: angry (task.playFacial)', 'success');
                    setTimeout(() => showDialog(dialogs.facial), 500);
                    break;
                case 'facial_surprised':
                    log('Playing facial animation: surprised (task.playFacial)', 'success');
                    setTimeout(() => showDialog(dialogs.facial), 500);
                    break;
                case 'camera_follow':
                    log('Camera mode: follow (task.camera.follow)', 'success');
                    setTimeout(() => showDialog(dialogs.camera), 500);
                    break;
                case 'camera_track':
                    log('Camera mode: track (task.camera.track)', 'success');
                    setTimeout(() => showDialog(dialogs.camera), 500);
                    break;
                case 'camera_orbit':
                    log('Camera mode: orbit (task.camera.orbit)', 'success');
                    setTimeout(() => showDialog(dialogs.camera), 500);
                    break;
                case 'data_save':
                    mockDataStore['test_key'] = { value: 42, timestamp: Date.now() };
                    log('Saved: task.data.set("test_key", 42)', 'success');
                    setTimeout(() => showDialog(dialogs.persistence), 500);
                    break;
                case 'data_load':
                    const data = mockDataStore['test_key'];
                    if (data) {
                        log(`Loaded: task.data.get("test_key") = ${data.value}`, 'success');
                    } else {
                        log('No data found (would return default)', 'warning');
                    }
                    setTimeout(() => showDialog(dialogs.persistence), 500);
                    break;
                case 'data_check':
                    const isCompleted = mockDataStore['dialog_completed_test'];
                    log(`task.data.isCompleted("test") = ${isCompleted ? 'true' : 'false'}`, 'info');
                    setTimeout(() => showDialog(dialogs.persistence), 500);
                    break;
                case 'veh_closest':
                    log('task.vehicle.getClosest(50.0) - Would return closest vehicle', 'success');
                    setTimeout(() => showDialog(dialogs.vehicle), 500);
                    break;
                case 'veh_hood':
                    log('task.goToVehicle(ped, veh, "bonnet", {x=0, y=1.5, z=0})', 'success');
                    setTimeout(() => showDialog(dialogs.vehicle), 500);
                    break;
                default:
                    log(`Unknown action: ${action}`, 'error');
            }
        }

        // Preset dialog functions
        function showSimpleDialog() {
            showDialog(dialogs.simple);
        }

        function showChainDialog() {
            mockDialogHistory = [];
            showDialog(dialogs.nav_start);
        }

        function showBackButtonDialog() {
            mockDialogHistory = [];
            showDialog(dialogs.nav_start);
            log('Back button appears automatically with history', 'info');
        }

        function showFacialAnimationDialog() {
            showDialog(dialogs.facial);
            log('Facial presets: happy, angry, sad, surprised, aiming, injured, concentrated', 'info');
        }

        function showCameraDialog() {
            showDialog(dialogs.camera);
            log('Camera modes: static, follow, track, orbit', 'info');
        }

        function showDataPersistenceDialog() {
            showDialog(dialogs.persistence);
            log('SQL persistence with MariaDB triggers (100 limit, 30-day expiry)', 'info');
        }

        function showVehicleHelperDialog() {
            showDialog(dialogs.vehicle);
            log('Vehicle helpers: getClosest, getByModel, getByPlate, getInFront', 'info');
        }

        function showLongDialog() {
            showDialog(dialogs.long);
        }

        function showCustomDialog() {
            const speaker = document.getElementById('speakerInput').value || 'Custom NPC';
            const text = document.getElementById('textInput').value || 'Custom dialog text here...';
            const option1 = document.getElementById('option1Input').value || 'Option 1';
            const option2 = document.getElementById('option2Input').value || 'Option 2';

            const customDialog = {
                id: "custom_dialog",
                speaker: speaker,
                text: text,
                options: [
                    { label: option1, close: true },
                    { label: option2, close: true }
                ]
            };

            showDialog(customDialog);
        }

        function closeDialog() {
            hideDialog();
        }

        // Mock fetch
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('/selectOption')) {
                return new Promise((resolve) => {
                    resolve({
                        ok: true,
                        text: () => Promise.resolve('OK')
                    });
                });
            }
            return originalFetch(url, options);
        };

        // Initialize
        $(document).ready(function() {
            log('Advance Dialog V2 Mock initialized', 'success');
            log('Ready to showcase: onSelect, task.data.*, navigation, facial anims, cameras', 'info');

            // ESC key listener
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && mockActiveDialogId !== null) {
                    hideDialog();
                }
            });
        });
    </script>
</body>
</html>